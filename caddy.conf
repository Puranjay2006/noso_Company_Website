# =============================================================================
# NoSo Company Configuration
# =============================================================================
# Frontend: Static files served directly by Caddy
# Backend: FastAPI/Uvicorn served on port 8080
# SSL: Auto (Let's Encrypt)
# SSE: Server-Sent Events support for streaming

# Redirect www to non-www (canonical URL)
www.nosocompany.com {
	redir https://nosocompany.com{uri} permanent
}

nosocompany.com {
	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
	}

	# Max upload size 60MB
	request_body {
		max_size 60MB
	}

	# Backend API routes - FastAPI on port 8080
	# CORS is handled by FastAPI backend - don't duplicate here
	handle /api/* {
		reverse_proxy localhost:8080 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}
			header_up Connection "keep-alive"
			header_up X-Accel-Buffering "no"

			# SSE support - disable buffering
			flush_interval -1
		}

		header {
			Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
			Pragma "no-cache"
			Expires "0"
			X-Accel-Buffering "no"
		}
	}

	# Frontend - Static files served directly by Caddy
	handle {
		root * /var/www/nosocompany/dist

		# Cache static assets (JS, CSS, images) for 1 year
		@static path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
		header @static Cache-Control "public, max-age=31536000, immutable"

		# SPA fallback - serve index.html for client-side routing
		try_files {path} /index.html
		file_server
	}
}
